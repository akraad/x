<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ابزارک‌های هوشمند</title>
    <link href="https://cdn.fontcdn.ir/Font/Persian/Shabnam/Shabnam.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Shabnam', 'Vazirmatn', sans-serif;
            background-color: #1a1a1a; /* Dark background */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #f0f0f0; /* Light text */
            padding: 20px;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- Theme Toggle Button --- */
        .icon-button {
            background: none;
            border: none;
            color: #f0f0f0;
            font-size: 1.4em;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: fixed;
            top: 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .icon-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #FFD700; /* Gold on hover */
        }
        #themeToggle { right: 20px; }


        /* Light Theme Specific Styles */
        body.light-theme {
            background: linear-gradient(to bottom right, #f0f0f0, #e0e0e0); /* Grey gradient background */
            color: #333; /* Dark text */
        }
        body.light-theme .navbar,
        body.light-theme .app-container,
        body.light-theme .modal-content {
            background-color: #ffffff;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }
        body.light-theme .nav-button {
            background-color: #f8f9fa;
            color: #555;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid #dee2e6;
        }
        body.light-theme .nav-button:hover {
            background-color: #e2e6ea;
            color: #333;
        }
        body.light-theme .nav-button.active {
            background-color: #e9ecef;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1), inset 0 0 10px rgba(0, 0, 0, 0.05);
            color: #333;
        }
        body.light-theme .nav-button i {
            color: #888;
        }
        body.light-theme .nav-button.active i {
            color: #333;
        }
        body.light-theme h1,
        body.light-theme .input-group label,
        body.light-theme .result {
            color: #333;
        }
        body.light-theme .modal-content h2,
        body.light-theme .modal-content p {
            color: #333;
        }
        body.light-theme .input-group input,
        body.light-theme .input-group select {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            color: #333;
        }
        body.light-theme .input-group input::placeholder {
            color: #777;
        }
        body.light-theme .input-group .icon {
            color: #888;
        }
        body.light-theme .input-group small {
            color: #666;
        }
        body.light-theme .result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }
        body.light-theme .personality-text {
            background-color: #f8f9fa;
            border: 1px dashed #ced4da;
            color: #333;
        }
        body.light-theme .personality-text h2 {
            color: #CC9900; /* Darker Gold for Light theme */
        }
        body.light-theme .personality-text h3 {
            color: #CC6600; /* Darker Orange for Light theme */
        }
        body.light-theme .personality-text li {
            color: #444;
        }
        body.light-theme .positive-point {
            color: #1e7e34; /* Darker Green */
        }
        body.light-theme .negative-point {
            color: #bd2130; /* Darker Red */
        }
        body.light-theme .comparison-section {
            border-top-color: #dee2e6;
        }
        body.light-theme .tab-button {
            background-color: #e9ecef;
            border: 15px solid #ced4da;
            color: #555;
        }
        body.light-theme .tab-button.active {
            background-color: #6a006a; /* Darker Purple for contrast */
            border-color: #6a006a;
            color: white;
        }
        body.light-theme .toggle-switch {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
        }
        body.light-theme .toggle-switch span {
            color: #333;
        }
        body.light-theme .slider {
            background-color: #bbb;
        }
        body.light-theme input:checked + .slider {
            background-color: #6a006a; /* Darker Purple */
        }
        body.light-theme input:focus + .slider {
            box-shadow: 0 0 1px #6a006a;
        }
        body.light-theme .activity-table th,
        body.light-theme .activity-table td {
            border: 1px solid #ced4da;
            color: #333;
        }
        body.light-theme .activity-table th {
            background-color: #e2e6ea;
            color: #CC9900; /* Darker Gold */
        }
        body.light-theme .activity-table td {
            background-color: #f8f9fa;
        }
        body.light-theme .activity-table td:first-child {
            color: #CC6600; /* Darker Orange */
        }
        body.light-theme .total-cost-row {
            background-color: #e9ecef;
            color: #1e7e34 !important; /* Darker Green */
        }
        body.light-theme .total-cost-row td {
            color: #1e7e34 !important; /* Darker Green */
        }
        body.light-theme .suggestion-section h3 {
            color: #CC6600; /* Darker Orange */
        }
        body.light-theme .suggestion-section .highlight {
            color: #1e7e34; /* Darker Green */
        }
        body.light-theme .comparison-result h3,
        body.light-theme .food-comparison-list li::before {
            color: #CC9900;
        }
        body.light-theme .comparison-result p,
        body.light-theme .food-comparison-list li {
            color: #444;
        }
        body.light-theme .food-comparison-list li::before {
            color: #1e7e34;
        }
        body.light-theme .modal-content .input-group input,
        body.light-theme .modal-content .input-group select {
            background-color: #f0f2f5;
        }
        body.light-theme #activityOptions {
            background-color: #f0f2f5;
            border: 1px solid #ced4da;
        }
        body.light-theme .activity-item-option {
            background-color: #ffffff !important;
            border: 1px solid #e0e0e0 !important;
        }
        body.light-theme .activity-item-option label {
            color: #333 !important;
        }
        body.light-theme .activity-item-option input[type="number"] {
            background-color: #e9ecef !important;
            color: #333 !important;
        }
        body.light-theme .plus-minus-buttons button {
            background-color: #cccccc; /* Light grey for buttons in light theme */
            color: #333; /* Dark text for buttons */
        }
        body.light-theme .plus-minus-buttons button:hover {
            background-color: #b0b0b0;
        }
        body.light-theme .overspend-warning {
            color: #d9534f; /* Darker red for warning in light theme */
        }

        /* --- Dynamic Navbar Styles --- */
        .navbar {
            display: flex;
            justify-content: center;
            background-color: #2a2a2a; /* Slightly lighter dark */
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 950px;
            flex-wrap: wrap;
            gap: 10px;
            border: 1px solid #3a3a3a;
        }
        .nav-button {
            background-color: #3a3a3a;
            color: #e0e0e0;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-grow: 1;
            min-width: 130px;
            max-width: 190px;
            font-weight: 600;
            display: flex;
            flex-direction: column; /* Stack icon and text */
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid transparent; /* Default transparent border */
        }
        .nav-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px; /* Border thickness */
            background-color: transparent;
            transition: background-color 0.3s ease;
        }

        /* Specific colors for each button's border and hover/active states */
        .nav-button[data-color="gold"]:before { background-color: #FFD700; } /* Gold */
        .nav-button[data-color="green"]:before { background-color: #28a745; } /* Green */
        .nav-button[data-color="orange"]:before { background-color: #FFA500; } /* Orange */
        .nav-button[data-color="purple"]:before { background-color: #800080; } /* Purple */
        .nav-button[data-color="blue"]:before { background-color: #1e90ff; } /* Blue */
        .nav-button[data-color="red"]:before { background-color: #dc3545; } /* Red */

        .nav-button:hover {
            background-color: #4a4a4a;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            color: #ffffff;
        }
        .nav-button.active {
            background-color: #5a5a5a;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(0, 0, 0, 0.3);
            transform: translateY(0);
            color: #ffffff;
            border-color: var(--button-color); /* Use CSS variable for active border */
        }
        .nav-button i {
            margin-bottom: 8px; /* Space between icon and text */
            margin-left: 0; /* Remove left margin for stacking */
            font-size: 1.3em;
            color: #bbb;
        }
        .nav-button.active i {
            color: #fff;
        }

        /* --- Common App Container Styles --- */
        .app-container {
            background-color: #2a2a2a; /* Darker grey background for containers */
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            padding: 30px;
            width: 100%;
            max-width: 450px;
            text-align: center;
            border: 1px solid #3a3a3a;
            display: none; /* Initially hidden */
            transition: all 0.4s ease-in-out;
        }
        .app-container h1 {
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }
        .input-group {
            margin-bottom: 20px;
            text-align: right;
            position: relative;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95em;
            color: #e0e0e0;
        }
        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group select {
            width: calc(100% - 40px);
            padding: 12px 15px 12px 35px;
            border: 1px solid #555;
            border-radius: 8px;
            font-size: 1em;
            background-color: #3a3a3a;
            color: #f0f0f0;
            direction: ltr; /* Default for inputs */
            text-align: right;
            transition: border-color 0.3s, box-shadow 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-left: 45px;
        }

        .input-group select {
            width: calc(100% - 15px);
            padding-left: 15px; /* Adjust padding for select */
            direction: rtl; /* For Persian text in select */
            cursor: pointer;
        }
        .input-group select option {
            background-color: #3a3a3a; /* Darker background for options */
            color: #f0f0f0;
            padding: 8px;
        }

        .input-group input[type="number"]:focus,
        .input-group input[type="text"]:focus,
        .input-group select:focus {
            outline: none;
            border-color: #1e90ff; /* Default focus blue */
            box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.3);
        }
        .input-group .icon {
            position: absolute;
            left: 12px;
            top: 50%; /* Center vertically with label and input */
            transform: translateY(calc(-50% + 12px)); /* Adjust for label height */
            color: #aaa;
            font-size: 1.1em;
            pointer-events: none; /* Make icon not clickable */
        }
        .input-group small {
            display: block;
            margin-top: 5px;
            color: #bbb;
            font-size: 0.8em;
            text-align: right;
        }
        .flex-inputs {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .flex-inputs .input-group {
            flex: 1;
            margin-bottom: 0;
        }
        .flex-inputs .input-group label {
            white-space: nowrap;
        }
        .app-container button {
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.05em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            font-weight: 600;
            margin-top: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
        }
        .app-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.5);
        }
        .result {
            margin-top: 30px;
            background-color: #3a3a3a;
            border: 1px solid #555;
            border-radius: 10px;
            padding: 20px;
            font-size: 1.1em;
            color: #f0f0f0;
            font-weight: 600;
            display: none;
            text-align: right;
            line-height: 1.8;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.4);
        }
        .result div {
            margin-bottom: 8px;
        }
        .result span {
            font-size: 1em;
            margin-right: 8px;
            font-weight: 700;
        }
        .result .small-text {
            font-size: 0.75em;
            color: #bbb;
            display: block;
            margin-top: 15px;
            font-weight: normal;
        }
        .personality-text {
            font-size: 1.05em;
            font-weight: normal;
            margin-top: 20px;
            text-align: justify;
            background-color: #3a3a3a;
            border: 1px dashed #555;
            padding: 20px;
            border-radius: 10px;
            color: #e0e0e0;
            line-height: 1.7;
        }
        .personality-text h2 {
            color: #FFD700; /* Gold for titles in personality */
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
        }
        .personality-text h3 {
            color: #ffa500; /* Orange for subheadings */
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 10px;
            text-align: right;
        }
        .personality-text ul {
            list-style-type: disc;
            padding-right: 25px;
            margin-bottom: 15px;
        }
        .personality-text li {
            margin-bottom: 5px;
            color: #e0e0e0;
        }
        .positive-point {
            color: #8aff8a; /* Lighter green */
            font-weight: 600;
        }
        .negative-point {
            color: #ff8a8a; /* Lighter red */
            font-weight: 600;
        }
        .comparison-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #555;
            text-align: right;
        }
        .comparison-section label {
            font-size: 0.95em;
            color: #e0e0e0;
            display: block;
            margin-bottom: 12px;
        }
        .comparison-section select {
            width: calc(100% - 15px);
            padding: 10px 10px 10px 10px;
            border: 1px solid #555;
            border-radius: 8px;
            font-size: 0.95em;
            direction: rtl;
            background-color: #3a3a3a;
            color: #f0f0f0;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .comparison-section button {
            margin-top: 15px;
            background-color: #1e90ff; /* Blue for comparison button */
        }
        .comparison-result {
            margin-top: 20px;
            background-color: #3a3a3a;
            border: 1px solid #555;
            border-radius: 10px;
            padding: 20px;
            text-align: right;
        }
        .comparison-result h3 {
            font-size: 1.2em;
            color: #FFD700; /* Gold */
            margin-bottom: 15px;
            text-align: center;
        }
        .comparison-result p {
            font-size: 0.95em;
            line-height: 1.7;
            color: #e0e0e0;
            margin-bottom: 10px;
        }

        /* --- Loan/Deposit Calculator Specific Styles --- */
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
        }
        .tab-button {
            background-color: #3a3a3a;
            border: 1px solid #555;
            padding: 10px 18px;
            cursor: pointer;
            font-size: 0.95em;
            border-radius: 8px 8px 0 0;
            margin: 0 3px;
            transition: all 0.2s ease;
            color: #e0e0e0;
        }
        .tab-button.active {
            background-color: #800080; /* Purple */
            color: white;
            border-color: #800080;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        .loan-deposit-content {
            display: none;
        }
        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            background-color: #3a3a3a;
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #555;
        }
        .toggle-switch span {
            font-size: 0.95em;
            color: #e0e0e0;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 25px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #666;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 25px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #800080; /* Purple */
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #800080;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }

        /* --- Specific Form Colors --- */

        /* Gold Calculator */
        #goldCalculator h1 { color: #FFD700; }
        #goldCalculator .input-group input:focus { border-color: #FFD700; box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3); }
        #goldCalculator button { background-color: #FFD700; color: #333; }
        #goldCalculator button:hover { background-color: #e6c200; }
        #goldCalculator .result span { color: #FFD700; }

        /* BMI Calculator */
        #bmiCalculator h1 { color: #28a745; }
        #bmiCalculator .input-group input:focus { border-color: #28a745; box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3); }
        #bmiCalculator button { background-color: #28a745; }
        #bmiCalculator button:hover { background-color: #218838; }
        #bmiCalculator .result span { color: #28a745; }

        /* Personality Test */
        #personalityTest h1 { color: #FFA500; }
        #personalityTest .input-group input:focus,
        #personalityTest .input-group select:focus { border-color: #FFA500; box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.3); }
        #personalityTest button { background-color: #FFA500; }
        #personalityTest button:hover { background-color: #e69500; }
        #personalityTest .result span { color: #FFA500; }
        #personalityTest .comparison-section button { background-color: #1e90ff; }
        #personalityTest .comparison-section button:hover { background-color: #1a7ae0; }

        /* Loan/Deposit Calculator */
        #loanDepositCalculator h1 { color: #800080; } /* Purple */
        #loanDepositCalculator .input-group input:focus,
        #loanDepositCalculator .input-group select:focus { border-color: #800080; box-shadow: 0 0 0 3px rgba(128, 0, 128, 0.3); }
        #loanDepositCalculator button { background-color: #800080; }
        #loanDepositCalculator button:hover { background-color: #6a006a; }
        #loanDepositCalculator .result span { color: #800080; }

        /* Currency Converter */
        #currencyConverter h1 { color: #1e90ff; } /* Dodger Blue */
        #currencyConverter .input-group input:focus,
        #currencyConverter .input-group select:focus { border-color: #1e90ff; box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.3); }
        #currencyConverter button { background-color: #1e90ff; }
        #currencyConverter button:hover { background-color: #1a7ae0; }
        #currencyConverter .result span { color: #1e90ff; }

        /* Hypothetical Services Calculator */
        #hypotheticalServicesCalculator h1 { color: #dc3545; } /* Red */
        #hypotheticalServicesCalculator .input-group input:focus { border-color: #dc3545; box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3); }
        #hypotheticalServicesCalculator button { background-color: #dc3545; }
        #hypotheticalServicesCalculator button:hover { background-color: #c82333; }
        #hypotheticalServicesCalculator .result span { color: #dc3545; }
        #hypotheticalServicesCalculator .category-item {
            font-weight: bold;
            color: #FFD700; /* Gold for category names */
            margin-bottom: 8px;
        }
        #hypotheticalServicesCalculator .category-range {
            font-size: 0.85em;
            color: #aaa;
            margin-right: 5px;
            font-weight: normal;
        }
        #hypotheticalServicesCalculator ul {
            text-align: right;
            list-style-type: none; /* No default bullet */
            padding-right: 0;
            margin-top: 15px;
            color: #f0f0f0;
            font-size: 0.95em;
        }
        #hypotheticalServicesCalculator ul li {
            margin-bottom: 10px;
            position: relative;
            padding-right: 20px; /* Space for custom bullet */
        }
        #hypotheticalServicesCalculator ul li::before {
            content: "•"; /* Custom bullet point */
            color: #FFD700; /* Gold bullet */
            position: absolute;
            right: 0;
            top: 0;
            font-size: 1.2em;
        }
        #hypotheticalServicesCalculator .comparison-title {
            color: #1e90ff; /* Blue for comparison title */
            font-size: 1.1em;
            margin-top: 25px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .food-comparison-list {
            list-style-type: none;
            padding-right: 0;
            margin-top: 10px;
        }
        .food-comparison-list li {
            font-size: 0.9em;
            color: #ccc;
            margin-bottom: 8px;
            line-height: 1.5;
            position: relative;
            padding-right: 18px;
        }
        .food-comparison-list li::before {
            content: "•";
            color: #28a745; /* Green bullet for food */
            position: absolute;
            right: 0;
            top: 0;
            font-size: 1.1em;
        }
        .food-comparison-list strong {
            color: #eee;
        }
        .suggestion-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #555;
            text-align: right;
        }
        .suggestion-section h3 {
            color: #FFA500; /* Orange for suggestion titles */
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
        }
        .suggestion-section p {
            font-size: 0.95em;
            line-height: 1.8;
            color: #e0e0e0;
            margin-bottom: 10px;
        }
        .suggestion-section ul {
            list-style-type: disc;
            padding-right: 25px;
            margin-bottom: 15px;
        }
        .suggestion-section li {
            margin-bottom: 8px;
            color: #e0e0e0;
        }
        .suggestion-section .highlight {
            color: #8aff8a;
            font-weight: 700;
        }
        .overspend-warning {
            color: #dc3545; /* Red for warnings */
            font-weight: bold;
            margin-top: 15px;
            text-align: center;
        }


        /* Styles for the new detailed activity table */
        .activity-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            text-align: right;
            direction: rtl; /* Ensure table content is RTL */
        }
        .activity-table th, .activity-table td {
            border: 1px solid #555;
            padding: 10px;
            font-size: 0.9em;
            color: #f0f0f0;
        }
        .activity-table th {
            background-color: #4a4a4a;
            color: #FFD700; /* Gold for table headers */
            font-weight: 700;
            text-align: center;
        }
        .activity-table td {
            background-color: #3a3a3a;
        }
        .activity-table td:first-child { /* Activity Name */
            font-weight: 600;
            color: #FFA500; /* Orange for activity names */
        }
        .total-cost-row {
            font-weight: 700;
            background-color: #2a2a2a;
            color: #8aff8a !important; /* Green for total cost */
        }
        .total-cost-row td {
            color: #8aff8a !important; /* Green for total cost cells */
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            padding-top: 60px;
        }

        .modal-content {
            background-color: #2a2a2a;
            margin: 5% auto; /* 5% from the top and centered */
            padding: 30px;
            border: 1px solid #555;
            border-radius: 12px;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 500px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.6);
            position: relative;
            text-align: right;
        }

        .modal-content h2 {
            color: #1e90ff; /* Blue for modal titles */
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-content p {
            color: #e0e0e0;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .close-button {
            color: #aaa;
            float: left; /* Position on the left for RTL */
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            left: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: #f0f0f0;
            text-decoration: none;
            cursor: pointer;
        }

        #activityOptions {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 8px;
            background-color: #3a3a3a;
            text-align: right;
        }

        .activity-item-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            background-color: #2a2a2a;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #444;
        }
        .activity-item-option label {
            color: #e0e0e0 !important; /* Override general label color */
            margin-bottom: 0 !important;
            cursor: pointer;
        }
        .activity-item-option input[type="checkbox"] {
            margin-left: 10px;
            width: 18px;
            height: 18px;
            accent-color: #FFA500; /* Orange accent for checkboxes */
        }
        .activity-item-option input[type="number"] {
            width: 60px;
            padding: 6px;
            border-radius: 5px;
            border: 1px solid #666;
            background-color: #3a3a3a;
            color: #f0f0f0;
            text-align: center;
            margin-left: 8px;
        }
        .plus-minus-buttons {
            display: flex;
            gap: 5px;
            margin-left: 8px; /* Space between input and buttons */
        }
        .plus-minus-buttons button {
            background-color: #555;
            color: #fff;
            border: none;
            border-radius: 5px;
            width: 30px;
            height: 30px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
            padding: 0;
            margin: 0;
        }
        .plus-minus-buttons button:hover {
            background-color: #777;
        }


        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {
            .navbar {
                padding: 8px;
                max-width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            .nav-button {
                margin: 4px;
                flex-basis: calc(50% - 8px); /* Two buttons per row with gap */
                min-width: unset;
                font-size: 0.85em;
                padding: 10px 15px;
            }
            .app-container {
                padding: 20px;
                max-width: 380px;
            }
            .input-group input[type="number"],
            .input-group input[type="text"],
            .input-group select {
                width: calc(100% - 30px);
                padding: 10px 10px 10px 30px;
            }
            .input-group .icon {
                left: 8px;
                font-size: 1em;
                transform: translateY(calc(-50% + 10px));
            }
            .modal-content {
                width: 90%;
                margin: 20px auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <button id="themeToggle" class="icon-button"><i class="fas fa-sun"></i></button>

    <div class="navbar">
        <button class="nav-button active" data-target="goldCalculator" data-color="gold">
            <i class="fas fa-money-bill-alt"></i>
            <span>ماشین حساب طلا</span>
        </button>
        <button class="nav-button" data-target="bmiCalculator" data-color="green">
            <i class="fas fa-calculator"></i>
            <span>ماشین حساب BMI</span>
        </button>
        <button class="nav-button" data-target="personalityTest" data-color="orange">
            <i class="fas fa-user-check"></i>
            <span>شخصیت شناسی</span>
        </button>
        <button class="nav-button" data-target="loanDepositCalculator" data-color="purple">
            <i class="fas fa-hand-holding-usd"></i>
            <span>وام و سپرده</span>
        </button>
        <button class="nav-button" data-target="currencyConverter" data-color="blue">
            <i class="fas fa-coins"></i>
            <span>تبدیل ارز</span>
        </button>
        <button class="nav-button" data-target="hypotheticalServicesCalculator" data-color="red">
            <i class="fas fa-chart-line"></i>
            <span>بودجه لذت و خدمات</span>
        </button>
    </div>

    <div id="goldCalculator" class="app-container active">
        <h1>ماشین حساب طلا</h1>
        <div class="input-group">
            <label for="goldWeight">وزن طلا (گرم):</label>
            <input type="number" id="goldWeight" placeholder="مثال: 10" min="0" step="0.1">
            <i class="fas fa-weight-hanging icon"></i>
        </div>
        <div class="input-group">
            <label for="goldPurity">عیار طلا (مثال: 750 برای 18 عیار):</label>
            <input type="number" id="goldPurity" placeholder="مثال: 750" min="0" max="999" step="1">
            <i class="fas fa-percent icon"></i>
        </div>
        <div class="input-group">
            <label for="goldPricePerGram">قیمت هر گرم طلای 18 عیار (تومان):</label>
            <input type="number" id="goldPricePerGram" placeholder="مثال: 3,000,000" min="0">
            <i class="fas fa-lira-sign icon"></i>
        </div>
        <button onclick="calculateGoldPrice()">محاسبه قیمت طلا</button>
        <div id="goldResultDiv" class="result">
            <div>قیمت نهایی طلا: <span id="goldTotalPrice">0</span> تومان</div>
        </div>
    </div>

    <div id="bmiCalculator" class="app-container">
        <h1>ماشین حساب BMI</h1>
        <div class="input-group">
            <label for="weight">وزن (کیلوگرم):</label>
            <input type="number" id="weight" placeholder="مثال: 70" min="0">
            <i class="fas fa-weight icon"></i>
        </div>
        <div class="input-group">
            <label for="height">قد (سانتی‌متر):</label>
            <input type="number" id="height" placeholder="مثال: 175" min="0">
            <i class="fas fa-ruler-vertical icon"></i>
        </div>
        <button onclick="calculateBMI()">محاسبه BMI</button>
        <div id="bmiResultDiv" class="result">
            <div>BMI شما: <span id="bmiValue">0</span></div>
            <div>وضعیت: <span id="bmiStatus"></span></div>
        </div>
    </div>

    <div id="personalityTest" class="app-container">
        <h1>شخصیت شناسی متولدین ماه</h1>
        <div class="input-group">
            <label for="birthMonth">ماه تولد خود را انتخاب کنید:</label>
            <select id="birthMonth">
                <option value="">انتخاب کنید</option>
                <option value="فروردین">فروردین</option>
                <option value="اردیبهشت">اردیبهشت</option>
                <option value="خرداد">خرداد</option>
                <option value="تیر">تیر</option>
                <option value="مرداد">مرداد</option>
                <option value="شهریور">شهریور</option>
                <option value="مهر">مهر</option>
                <option value="آبان">آبان</option>
                <option value="آذر">آذر</option>
                <option value="دی">دی</option>
                <option value="بهمن">بهمن</option>
                <option value="اسفند">اسفند</option>
            </select>
            <i class="fas fa-calendar-alt icon"></i>
        </div>
        <button onclick="displayPersonalityTraits()">نمایش ویژگی‌های شخصیتی</button>
        <div id="personalityResultDiv" class="result" style="display: block;">
            <div id="personalityText"></div>
            <div id="comparisonSection" class="comparison-section">
                <label for="compareMonth">مقایسه با ماه دیگر:</label>
                <select id="compareMonth">
                    <option value="">انتخاب کنید</option>
                    <option value="فروردین">فروردین</option>
                    <option value="اردیبهشت">اردیبهشت</option>
                    <option value="خرداد">خرداد</option>
                    <option value="تیر">تیر</option>
                    <option value="مرداد">مرداد</option>
                    <option value="شهریور">شهریور</option>
                    <option value="مهر">مهر</option>
                    <option value="آبان">آبان</option>
                    <option value="آذر">آذر</option>
                    <option value="دی">دی</option>
                    <option value="بهمن">بهمن</option>
                    <option value="اسفند">اسفند</option>
                </select>
                <button onclick="comparePersonalities()">مقایسه شخصیت‌ها</button>
                <div id="comparisonResultDiv" class="comparison-result">
                    <div id="comparisonText"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="loanDepositCalculator" class="app-container">
        <h1>ماشین حساب وام و سپرده</h1>
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showLoanDepositTab('loan', this)">وام</button>
            <button class="tab-button" onclick="showLoanDepositTab('deposit', this)">سپرده</button>
        </div>

        <div id="loanContent" class="loan-deposit-content active">
            <div class="input-group">
                <label for="loanAmount">مبلغ وام (تومان):</label>
                <input type="number" id="loanAmount" placeholder="مثال: 100,000,000" min="0">
                <i class="fas fa-money-check-alt icon"></i>
            </div>
            <div class="input-group">
                <label for="loanInterestRate">نرخ سود سالانه وام (درصد):</label>
                <input type="number" id="loanInterestRate" placeholder="مثال: 18" min="0" step="0.1">
                <i class="fas fa-percent icon"></i>
            </div>
            <div class="input-group">
                <label for="loanDuration">مدت بازپرداخت (ماه):</label>
                <input type="number" id="loanDuration" placeholder="مثال: 36" min="1">
                <i class="fas fa-calendar-alt icon"></i>
            </div>
            <button onclick="calculateLoan()">محاسبه وام</button>
            <div id="loanResultDiv" class="result">
                <div>قسط ماهانه: <span id="monthlyInstallment">0</span> تومان</div>
                <div>کل سود: <span id="totalLoanInterest">0</span> تومان</div>
                <div>کل مبلغ بازپرداخت: <span id="totalPayment">0</span> تومان</div>
            </div>
        </div>

        <div id="depositContent" class="loan-deposit-content">
            <div class="input-group">
                <label for="depositAmount">مبلغ سپرده (تومان):</label>
                <input type="number" id="depositAmount" placeholder="مثال: 50,000,000" min="0">
                <i class="fas fa-wallet icon"></i>
            </div>
            <div class="input-group">
                <label for="depositInterestRate">نرخ سود سالانه سپرده (درصد):</label>
                <input type="number" id="depositInterestRate" placeholder="مثال: 20" min="0" step="0.1">
                <i class="fas fa-percent icon"></i>
            </div>
            <div class="input-group">
                <label for="depositDurationDays">مدت سپرده گذاری (روز): <span id="depositDurationLabel">365 روز</span></label>
                <input type="range" id="depositDurationDays" min="1" max="1825" value="365" oninput="updateDepositDurationLabel()">
            </div>
            <div class="toggle-switch">
                <span>محاسبه روز شمار</span>
                <label class="switch">
                    <input type="checkbox" id="dailyInterestToggle">
                    <span class="slider round"></span>
                </label>
            </div>
            <button onclick="calculateDeposit()">محاسبه سپرده</button>
            <div id="depositResultDiv" class="result">
                <div>سود قابل دریافت: <span id="depositInterestEarned">0</span> تومان</div>
                <div>مجموع قابل دریافت: <span id="totalDepositAmount">0</span> تومان</div>
            </div>
        </div>
    </div>

    <div id="currencyConverter" class="app-container">
        <h1>تبدیل ارز</h1>
        <div class="input-group">
            <label for="amountToConvert">مبلغ:</label>
            <input type="number" id="amountToConvert" placeholder="مثال: 1000" min="0">
            <i class="fas fa-money-bill-wave icon"></i>
        </div>
        <div class="input-group">
            <label for="fromCurrency">از ارز:</label>
            <select id="fromCurrency"></select>
            <i class="fas fa-exchange-alt icon"></i>
        </div>
        <div class="input-group">
            <label for="toCurrency">به ارز:</label>
            <select id="toCurrency"></select>
            <i class="fas fa-exchange-alt icon"></i>
        </div>
        <button onclick="convertCurrency()">تبدیل ارز</button>
        <div id="currencyResultDiv" class="result">
            <div>مبلغ تبدیل شده: <span id="convertedAmount">0</span></div>
        </div>
    </div>

    <div id="hypotheticalServicesCalculator" class="app-container">
        <h1>بودجه لذت و خدمات</h1>
        <div class="input-group">
            <label for="dollarExchangeRateHypothetical">نرخ روز دلار به تومان:</label>
            <input type="number" id="dollarExchangeRateHypothetical" placeholder="مثال: 50000" min="1" step="100">
            <i class="fas fa-dollar-sign icon"></i>
        </div>
        <div class="input-group">
            <label for="hypotheticalBudget">درآمد ماهانه (تومان):</label>
            <input type="number" id="hypotheticalBudget" placeholder="مثال: 30,000,000" min="0">
            <i class="fas fa-sack-dollar icon"></i>
        </div>
        <div class="input-group">
            <label for="userAge">سن شما:</label>
            <input type="number" id="userAge" placeholder="مثال: 30" min="1">
            <i class="fas fa-user icon"></i>
        </div>
        <div class="input-group">
            <label for="userOccupation">شغل شما:</label>
            <select id="userOccupation"></select>
            <i class="fas fa-briefcase icon"></i>
        </div>
        <div class="input-group">
            <label for="maritalStatus">وضعیت تأهل:</label>
            <select id="maritalStatus">
                <option value="">انتخاب کنید</option>
                <option value="مجرد">مجرد</option>
                <option value="متاهل">متاهل</option>
            </select>
            <i class="fas fa-heart icon"></i>
        </div>
        <div id="childrenCountGroup" class="input-group" style="display: none;">
            <label for="childrenCount">تعداد فرزندان:</label>
            <input type="number" id="childrenCount" placeholder="مثال: 0" min="0">
            <i class="fas fa-child icon"></i>
        </div>
        <div class="input-group">
            <label for="livingArea">محل زندگی:</label>
            <select id="livingArea">
                <option value="">انتخاب کنید</option>
                <option value="شهری">شهری</option>
                <option value="روستایی">روستایی</option>
            </select>
            <i class="fas fa-city icon"></i>
        </div>
        <div class="input-group">
            <label for="houseOwnership">وضعیت مالکیت خانه:</label>
            <select id="houseOwnership">
                <option value="">انتخاب کنید</option>
                <option value="مالک">مالک</option>
                <option value="مستأجر">مستأجر</option>
            </select>
            <i class="fas fa-home icon"></i>
        </div>
        <div class="input-group">
            <label for="carOwnership">وضعیت مالکیت خودرو:</label>
            <select id="carOwnership">
                <option value="">انتخاب کنید</option>
                <option value="دارم">دارم</option>
                <option value="ندارم">ندارم</option>
            </select>
            <i class="fas fa-car icon"></i>
        </div>

        <button onclick="showActivitySelectionModal()">انتخاب تفریحات دلخواه</button>
        <button onclick="calculateHypotheticalServices()">محاسبه بودجه لذت و خدمات</button>
        <div id="hypotheticalServicesResultDiv" class="result">
            <div>درآمد ماهانه: <span id="displayMonthlyIncome">0</span> تومان</div>
            <div>جمع کل هزینه‌های تفریحات و خدمات انتخابی: <span id="totalActivityCost">0</span></div>
            <div>مبلغ باقیمانده/کسری: <span id="remainingOrDeficitAmount">0</span> تومان</div>
            <div id="budgetSuggestionText" class="suggestion-section"></div>
            <div id="expenseCutSuggestions" class="suggestion-section" style="display: none;">
                <h3 class="overspend-warning">هشدار: شما این ماه بیش از درآمد خود هزینه کرده‌اید!</h3>
                <p>برای تعادل دخل و خرج، پیشنهاد می‌کنیم موارد زیر را کاهش دهید یا حذف کنید:</p>
                <ul id="cutSuggestionsList"></ul>
            </div>
            <div id="activityDetails" style="margin-top: 20px;">
                <h3>جزئیات هزینه‌های تفریحات انتخابی</h3>
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th>نام فعالیت</th>
                            <th>تعداد/میزان</th>
                            <th>هزینه حدودی (تومان)</th>
                        </tr>
                    </thead>
                    <tbody id="activityTableBody">
                        </tbody>
                    <tfoot>
                        <tr class="total-cost-row">
                            <td colspan="2">کل هزینه‌های تفریحات:</td>
                            <td id="totalActivityCostFooter">0 تومان</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div id="activitySelectionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeActivitySelectionModal()">&times;</span>
            <h2>انتخاب تفریحات و خدمات دلخواه</h2>
            <p>فعالیت‌هایی که معمولاً در ماه انجام می‌دهید را انتخاب کنید و تعداد/مقدار آن را وارد کنید:</p>
            <div id="activityOptions">
                </div>
            <button onclick="saveSelectedActivities()">ذخیره تفریحات انتخاب شده</button>
        </div>
    </div>


    <script>
        let globalUserData = {};
        let selectedCustomActivities = []; // To store user's selected activities with quantities

        // Define a comprehensive list of services with min/max costs in USD
        const iranianServiceCostsUSD = {
            'یک فنجان قهوه در کافه': { min: 0.5, max: 3, type: 'leisure', unit: 'بار' },
            'یک فنجان چای در کافه': { min: 0.5, max: 1, type: 'leisure', unit: 'بار' },
            'بلیط سینما و یک نوشیدنی': { min: 2.5, max: 7, type: 'culture', unit: 'بار' },
            'یک وعده غذای فست فود': { min: 3, max: 8, type: 'food', unit: 'بار' },
            'یک وعده غذای رستورانی (اقتصادی)': { min: 5, max: 12, type: 'food', unit: 'بار' },
            'یک وعده غذای رستورانی (لوکس)': { min: 15, max: 40, type: 'food', unit: 'بار' },
            'خدمات آرایشی/پیرایش ساده': { min: 3, max: 10, type: 'personal', unit: 'بار' },
            'اینترنت ماهانه خانگی': { min: 5, max: 15, type: 'fixed', unit: 'ماه' },
            'قبوض آب و برق و گاز (ماهانه)': { min: 10, max: 30, type: 'fixed', unit: 'ماه' },
            'حمل و نقل عمومی (ماهیانه)': { min: 5, max: 10, type: 'transport', unit: 'ماه' },
            'لوازم بهداشتی/شوینده (ماهانه)': { min: 5, max: 20, type: 'fixed', unit: 'ماه' },
            'میوه و سبزیجات (ماهانه)': { min: 20, max: 50, type: 'food', unit: 'ماه' },
            'پروتئین (گوشت، مرغ، ماهی) (ماهانه)': { min: 30, max: 100, type: 'food', unit: 'ماه' },
            'پوشاک (ماهانه، تقریبی)': { min: 10, max: 50, type: 'personal', unit: 'ماه' },
            'شهریه باشگاه ورزشی (ماهانه)': { min: 6, max: 20, type: 'health', unit: 'ماه' },
            'یک بار استفاده از استخر': { min: 2, max: 4, type: 'health', unit: 'بار' },
            'خرید یک کتاب جدید': { min: 1.5, max: 4, type: 'education', unit: 'کتاب' },
            'اشتراک ماهانه نرم‌افزار کاربردی': { min: 2, max: 10, type: 'education', unit: 'ماه' },
            'کلاس آموزشی آنلاین/ورزش‌های انفرادی (ماهانه)': { min: 2, max: 10, type: 'education', unit: 'ماه' },
            'هزینه مسافرت داخلی/خارجی (به ازای هر نفر در روز، اقتصادی)': { min: 10, max: 30, type: 'travel', unit: 'روز' },
            'هزینه مسافرت داخلی/خارجی (به ازای هر نفر در روز، رفاهی)': { min: 30, max: 100, type: 'travel', unit: 'روز' },
            'تعمیر و نگهداری خودرو (ماهیانه، تقریبی)': { min: 10, max: 50, type: 'transport', unit: 'ماه' },
            'بنزین/سوخت خودرو (ماهیانه، تقریبی)': { min: 15, max: 40, type: 'transport', unit: 'ماه' },
            'تاکسی/اسنپ (شهری)': { min: 1.5, max: 3, type: 'transport', unit: 'بار' },
            'اجاره خانه شهری (ماهیانه)': { min: 150, max: 500, type: 'fixed' },
            'اجاره خانه روستایی (ماهیانه)': { min: 50, max: 100, type: 'fixed' },
            'هزینه هر پاکت سیگار': { min: 0.5, max: 1, type: 'luxury', unit: 'پاکت' },
            'مشروب (1.5 لیتری عرق سگی)': { min: 10, max: 10, type: 'luxury', unit: 'بطری' },
            'مشروب (ویسکی 50 دلاری)': { min: 50, max: 50, type: 'luxury', unit: 'بطری' }
        };

        const allActivities = {
            'نوشیدنی‌ها و تنقلات': [
                { id: 'coffee', name: 'یک فنجان قهوه در کافه', minCost: 0.5, maxCost: 3, type: 'leisure', unit: 'بار' },
                { id: 'tea', name: 'یک فنجان چای در کافه', minCost: 0.5, maxCost: 1, type: 'leisure', unit: 'بار' },
                { id: 'cigarette', name: 'پاکت سیگار', minCost: 0.5, maxCost: 1, type: 'luxury', unit: 'پاکت' },
                { id: 'arak', name: 'بطری عرق سگی (1.5 لیتری)', minCost: 10, maxCost: 10, type: 'luxury', unit: 'بطری' },
                { id: 'whiskey', name: 'بطری ویسکی (50 دلاری)', minCost: 50, maxCost: 50, type: 'luxury', unit: 'بطری' },
            ],
            'تفریحات و سرگرمی': [
                { id: 'cinema', name: 'بلیط سینما و یک نوشیدنی', minCost: 2.5, maxCost: 7, type: 'culture', unit: 'بار' },
                { id: 'gaming', name: 'هزینه گیم نت/بازی (ساعتی)', minCost: 1, maxCost: 3, type: 'leisure', unit: 'ساعت' },
                { id: 'park', name: 'هزینه یک گردش در پارک/فضای سبز', minCost: 0.5, maxCost: 2, type: 'free', unit: 'بار' }
            ],
            'غذا و رستوران': [
                { id: 'fastFood', name: 'یک وعده غذای فست فود', minCost: 3, maxCost: 8, type: 'food', unit: 'بار' },
                { id: 'economicRestaurant', name: 'یک وعده غذای رستورانی (اقتصادی)', minCost: 5, maxCost: 12, type: 'food', unit: 'بار' },
                { id: 'luxuryRestaurant', name: 'یک وعده غذای رستورانی (لوکس)', minCost: 15, maxCost: 40, type: 'food', unit: 'بار' }
            ],
            'حمل و نقل': [
                { id: 'publicTransport', name: 'حمل و نقل عمومی (ماهیانه)', minCost: 5, maxCost: 10, type: 'transport', unit: 'ماه' },
                { id: 'taxiTrip', name: 'تاکسی/اسنپ (شهری)', minCost: 1.5, maxCost: 3, type: 'transport', unit: 'بار' },
                { id: 'carFuel', name: 'بنزین/سوخت خودرو (ماهیانه، تقریبی)', minCost: 15, maxCost: 40, type: 'transport', unit: 'ماه' }
            ],
            'ورزش و سلامت': [
                { id: 'gym', name: 'شهریه باشگاه ورزشی (ماهانه)', minCost: 6, maxCost: 20, type: 'health', unit: 'ماه' },
                { id: 'pool', name: 'یک بار استفاده از استخر', minCost: 2, maxCost: 4, type: 'health', unit: 'بار' },
                { id: 'sportClass', name: 'کلاس آموزشی آنلاین/ورزش‌های انفرادی (ماهانه)', minCost: 2, maxCost: 10, type: 'education', unit: 'ماه' }
            ],
            'آموزش و توسعه فردی': [
                { id: 'book', name: 'خرید یک کتاب جدید', minCost: 1.5, maxCost: 4, type: 'education', unit: 'کتاب' },
                { id: 'softwareSub', name: 'اشتراک ماهانه نرم‌افزار کاربردی', minCost: 2, maxCost: 10, type: 'education', unit: 'ماه' },
                { id: 'workshop', name: 'شرکت در یک کارگاه/سمینار کوتاه', minCost: 5, maxCost: 25, type: 'education', unit: 'بار' }
            ],
            'مسافرت': [
                { id: 'domesticTravelEconomic', name: 'مسافرت داخلی (اقتصادی، هر روز)', minCost: 10, maxCost: 30, type: 'travel', unit: 'روز' },
                { id: 'domesticTravelLuxury', name: 'مسافرت داخلی (رفاهی، هر روز)', minCost: 30, maxCost: 100, type: 'travel', unit: 'روز' }
            ],
            'هزینه‌های ثابت و اساسی (تخمینی)': [
                { id: 'homeInternet', name: 'اینترنت ماهانه خانگی', minCost: 5, maxCost: 15, type: 'fixed', unit: 'ماه' },
                { id: 'bills', name: 'قبوض آب و برق و گاز (ماهانه)', minCost: 10, max: 30, type: 'fixed', unit: 'ماه' },
                { id: 'hygiene', name: 'لوازم بهداشتی/شوینده (ماهانه)', min: 5, max: 20, type: 'fixed', unit: 'ماه' },
                { id: 'fruitsVegetables', name: 'میوه و سبزیجات (ماهانه)', min: 20, max: 50, type: 'food', unit: 'ماه' },
                { id: 'protein', name: 'پروتئین (گوشت، مرغ، ماهی) (ماهانه)', min: 30, max: 100, type: 'food', unit: 'ماه' },
                { id: 'clothing', name: 'پوشاک (ماهانه، تقریبی)', min: 10, max: 50, type: 'personal', unit: 'ماه' },
                { id: 'carMaintenance', name: 'تعمیر و نگهداری خودرو (ماهیانه، تقریبی)', min: 10, max: 50, type: 'transport', unit: 'ماه' },
                { id: 'urbanRent', name: 'اجاره خانه شهری (ماهیانه)', min: 150, max: 500, type: 'fixed', unit: 'ماه' },
                { id: 'ruralRent', name: 'اجاره خانه روستایی (ماهیانه)', min: 50, max: 100, type: 'fixed', unit: 'ماه' }
            ]
        };


        // --- Navbar Functionality ---
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', function() {
                // Remove 'active' from all buttons and hide all containers
                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.app-container').forEach(container => container.style.display = 'none');

                // Add 'active' to the clicked button
                this.classList.add('active');

                // Show the corresponding app container
                const targetId = this.dataset.target;
                document.getElementById(targetId).style.display = 'block';

                // Set CSS variable for active border color
                document.documentElement.style.setProperty('--button-color', this.dataset.color);
            });
        });

        // --- Theme Toggle ---
        document.getElementById('themeToggle').addEventListener('click', () => {
            const body = document.body;
            const themeToggleBtn = document.getElementById('themeToggle');
            if (body.classList.contains('light-theme')) {
                body.classList.remove('light-theme');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.add('light-theme');
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
                localStorage.setItem('theme', 'light');
            }
        });

        // --- Gold Calculator Logic ---
        function calculateGoldPrice() {
            const weight = parseFloat(document.getElementById('goldWeight').value);
            const purity = parseFloat(document.getElementById('goldPurity').value);
            const pricePerGram = parseFloat(document.getElementById('goldPricePerGram').value.replace(/,/g, ''));

            if (isNaN(weight) || isNaN(purity) || isNaN(pricePerGram) || weight <= 0 || purity <= 0 || pricePerGram <= 0) {
                alert('لطفاً مقادیر صحیح و مثبت را وارد کنید.');
                return;
            }

            const goldPrice = (weight * purity * pricePerGram) / 750; // Assuming 750 is 18 carat gold standard
            document.getElementById('goldTotalPrice').innerText = goldPrice.toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('goldResultDiv').style.display = 'block';
        }

        // --- BMI Calculator Logic ---
        function calculateBMI() {
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value) / 100; // Convert cm to meters

            if (isNaN(weight) || isNaN(height) || weight <= 0 || height <= 0) {
                alert('لطفاً وزن و قد را به درستی وارد کنید.');
                return;
            }

            const bmi = weight / (height * height);
            let status;
            if (bmi < 18.5) {
                status = 'کم‌وزن';
            } else if (bmi >= 18.5 && bmi <= 24.9) {
                status = 'وزن طبیعی';
            } else if (bmi >= 25 && bmi <= 29.9) {
                status = 'اضافه وزن';
            } else {
                status = 'چاق';
            }

            document.getElementById('bmiValue').innerText = bmi.toFixed(2);
            document.getElementById('bmiStatus').innerText = status;
            document.getElementById('bmiResultDiv').style.display = 'block';
        }

        // --- Personality Test Logic ---
        const personalityTraits = {
            'فروردین': {
                'قوت': ['پرانرژی', 'پیشرو', 'شجاع', 'با اعتماد به نفس', 'مستقل'],
                'ضعف': ['بی‌صبر', 'تکانشی', 'خودمحور', 'عجول', 'پرخاشگر'],
                'توصیه': 'برای موفقیت بیشتر، سعی کنید در تصمیم‌گیری‌ها صبورتر باشید و به نظرات دیگران گوش فرا دهید.'
            },
            'اردیبهشت': {
                'قوت': ['قابل اعتماد', 'صبور', 'عملی', 'متعهد', 'مسئولیت‌پذیر'],
                'ضعف': ['لجباز', 'مصالحه ناپذیر', 'مالکیت طلب', 'حسود', 'خشک'],
                'توصیه': 'انعطاف‌پذیری بیشتر در برابر تغییرات و پذیرش دیدگاه‌های جدید، شما را در زندگی یاری می‌کند.'
            },
            'خرداد': {
                'قوت': ['مستعد', 'عاطفی', 'وفادار', 'متقاعد کننده', 'دلسوز'],
                'ضعف': ['ناپایدار', 'دمدمی مزاج', 'بدبین', 'شکاک', 'چسبنده'],
                'توصیه': 'کنترل احساسات و ثبات در تصمیم‌گیری‌ها می‌تواند به شما در روابط و اهدافتان کمک کند.'
            },
            'تیر': {
                'قوت': ['خلاق', 'سازگار', 'جذاب', 'انرژیک', 'اجتماعی'],
                'ضعف': ['عصبی', 'ناپایدار', 'دمدمی مزاج', 'کنجکاو', 'سرد'],
                'توصیه': 'تمرکز بر روی یک هدف و دوری از پراکندگی می‌تواند به شما در دستیابی به موفقیت‌های بزرگ کمک کند.'
            },
            'مرداد': {
                'قوت': ['سخاوتمند', 'مهربان', 'مبتکر', 'با اعتماد به نفس', 'رهبر'],
                'ضعف': ['خودبین', 'لجباز', 'بی‌طاقت', 'سلطه‌جو', 'عجول'],
                'توصیه': 'فروتنی و درک دیگران، توانایی‌های رهبری شما را تقویت می‌کند.'
            },
            'شهریور': {
                'قوت': ['تحلیلگر', 'سخت کوش', 'عملگرا', 'وفادار', 'مهربان'],
                'ضعف': ['خجالتی', 'نگران', 'سخت‌گیر', 'بیش از حد منتقد', 'وسواسی'],
                'توصیه': 'بیشتر به خودتان اعتماد کنید و از کمال‌گرایی بیش از حد بپرهیزید تا از زندگی لذت ببرید.'
            },
            'مهر': {
                'قوت': ['اجتماعی', 'منصف', 'صلح‌جو', 'همکار', 'دیپلماتیک'],
                'ضعف': ['تصمیم‌ناپذیر', 'از خود راضی', 'جنگنده', 'پایبند نبودن به برنامه', ' سطحی'],
                'توصیه': 'افزایش قاطعیت و توانایی تصمیم‌گیری مستقل، شما را در روابط و اهدافتان پیش می‌برد.'
            },
            'آبان': {
                'قوت': ['مصمم', 'شجاع', 'قدرتمند', 'پرشور', 'وفادار'],
                'ضعف': ['حسود', 'پنهان‌کار', 'کینه‌جو', 'خودخواه', 'شکاک'],
                'توصیه': 'اعتماد به دیگران و کنترل خشم، به شما در ایجاد روابط عمیق‌تر کمک می‌کند.'
            },
            'آذر': {
                'قوت': ['سخاوتمند', 'شوخ‌طبع', 'ایده‌آل‌گرا', 'برونگرا', 'خوش‌بین'],
                'ضعف': ['بی‌صبر', 'بی‌ملاحظه', 'بی‌قرار', 'نافرمان', 'لوس'],
                'توصیه': 'توجه به جزئیات و مسئولیت‌پذیری بیشتر، به شما در دستیابی به اهدافتان کمک می‌کند.'
            },
            'دی': {
                'قوت': ['مسئولیت‌پذیر', 'منضبط', 'خویشتن‌دار', 'مدیر', 'با تدبیر'],
                'ضعف': ['بدبین', 'متکبر', 'بی‌احساس', 'بدبین', 'یکدنده'],
                'توصیه': 'پذیرش ریسک‌پذیری بیشتر و دوری از بدبینی، افق‌های جدیدی را در زندگی شما باز می‌کند.'
            },
            'بهمن': {
                'قوت': ['مستقل', 'اصیل', 'پیشرو', 'بشردوست', 'روشنفکر'],
                'ضعف': ['غیرقابل پیش‌بینی', 'ناسازگار', 'دور از دسترس', 'غیرقابل نفوذ', 'تندخو'],
                'توصیه': 'نزدیکی بیشتر به احساسات خود و دیگران، به شما در برقراری ارتباطات عمیق‌تر کمک می‌کند.'
            },
            'اسفند': {
                'قوت': ['دلسوز', 'هنری', 'شهودی', 'مهربان', 'فداکار'],
                'ضعف': ['زودباور', 'ترسو', 'واقعیت گریز', 'خود ویرانگر', 'تنبل'],
                'توصیه': 'تمرکز بر روی اهداف و دوری از رویاپردازی بیش از حد، به شما در دستیابی به موفقیت‌های عملی کمک می‌کند.'
            }
        };

        function displayPersonalityTraits() {
            const birthMonth = document.getElementById('birthMonth').value;
            const personalityTextDiv = document.getElementById('personalityText');

            if (!birthMonth) {
                alert('لطفاً ماه تولد خود را انتخاب کنید.');
                personalityTextDiv.innerHTML = '';
                document.getElementById('comparisonResultDiv').style.display = 'none';
                return;
            }

            const traits = personalityTraits[birthMonth];
            let html = `<h2>ویژگی‌های شخصیتی متولد ${birthMonth}</h2>`;
            html += `<h3>نقاط قوت:</h3><ul>`;
            traits['قوت'].forEach(p => { html += `<li><span class="positive-point">${p}</span></li>`; });
            html += `</ul>`;
            html += `<h3>نقاط ضعف (نیاز به توجه):</h3><ul>`;
            traits['ضعف'].forEach(n => { html += `<li><span class="negative-point">${n}</span></li>`; });
            html += `</ul>`;
            html += `<p>${traits['توصیه']}</p>`;
            personalityTextDiv.innerHTML = html;
            document.getElementById('personalityResultDiv').style.display = 'block';
            document.getElementById('comparisonResultDiv').style.display = 'none'; // Hide comparison when displaying own traits
            document.getElementById('compareMonth').value = ''; // Clear compare month selection
        }

        function comparePersonalities() {
            const userMonth = document.getElementById('birthMonth').value;
            const compareMonth = document.getElementById('compareMonth').value;

            if (!userMonth || !compareMonth) {
                alert('لطفاً هر دو ماه را برای مقایسه انتخاب کنید.');
                document.getElementById('comparisonResultDiv').style.display = 'none';
                return;
            }
            if (userMonth === compareMonth) {
                alert('لطفاً دو ماه متفاوت را برای مقایسه انتخاب کنید.');
                document.getElementById('comparisonResultDiv').style.display = 'none';
                return;
            }

            const [userT, compareT] = [personalityTraits[userMonth], personalityTraits[compareMonth]];

            const commonP = userT['قوت'].filter(t => compareT['قوت'].includes(t));
            const commonN = userT['ضعف'].filter(t => compareT['ضعف'].includes(t));

            const userUniqueP = userT['قوت'].filter(t => !compareT['قوت'].includes(t));
            const compareUniqueP = compareT['قوت'].filter(t => !userT['قوت'].includes(t));

            let html = `<h3>مقایسه شخصیت متولد ${userMonth} با متولد ${compareMonth}:</h3>`;

            html += `<p><strong>نقاط مشترک مثبت:</strong> ${commonP.length ? commonP.map(t => `<span class="positive-point">${t}</span>`).join('، ') : 'مورد قابل توجهی یافت نشد.'}</p>`;

            if (userUniqueP.length || compareUniqueP.length) {
                html += `<p><strong>نقاط قوت متفاوت:</strong></p><ul>`;
                userUniqueP.forEach(t => html += `<li>متولد ${userMonth}: ${t}</li>`);
                compareUniqueP.forEach(t => html += `<li>متولد ${compareMonth}: ${t}</li>`);
                html += `</ul>`;
            }

            html += `<p><strong>نقاط مشترک منفی (نیاز به توجه):</strong> ${commonN.length ? commonN.map(t => `<span class="negative-point">${t}</span>`).join('، ') : 'مورد قابل توجهی یافت نشد.'}</p>`;

            const compatibilityScore = commonP.length * 2 - commonN.length * 2;
            let compatibilityStatement = compatibilityScore >= 3 ? "شما و متولد این ماه شباهت‌های مثبتی زیادی دارید و احتمالاً به خوبی با هم کنار می‌آیید. تفاهم کلی شما بالاست." :
                                       compatibilityScore >= 0 ? "شما و متولد این ماه می‌توانید در بسیاری از زمینه‌ها تفاهم داشته باشید، با کمی درک متقابل و پذیرش تفاوت‌ها." :
                                       "ممکن است در برخی زمینه‌ها چالش‌هایی در تفاهم با متولد این ماه داشته باشید. نیاز به درک بیشتر از تفاوت‌ها و تلاش برای سازگاری است.";
            html += `<p><strong>نتیجه کلی تفاهم:</strong> ${compatibilityStatement}</p>`;

            document.getElementById('comparisonText').innerHTML = html;
            document.getElementById('comparisonResultDiv').style.display = 'block';
        }

        // --- Loan/Deposit Calculator Logic (Concise) ---
        function showLoanDepositTab(tabId, clickedButton) {
            document.querySelectorAll('.loan-deposit-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));

            document.getElementById(tabId + 'Content').style.display = 'block';
            clickedButton.classList.add('active');

            // Reset results when switching tabs
            document.getElementById('depositResultDiv').style.display = 'none';
            document.getElementById('loanResultDiv').style.display = 'none';

            // Optionally clear inputs
            if (tabId === 'deposit') {
                document.getElementById('depositAmount').value = '';
                document.getElementById('depositInterestRate').value = '';
                document.getElementById('depositDurationDays').value = '365'; // Reset slider
                document.getElementById('dailyInterestToggle').checked = false;
                updateDepositDurationLabel(); // Update label to default
            } else { // loan
                document.getElementById('loanAmount').value = '';
                document.getElementById('loanInterestRate').value = '';
                document.getElementById('loanDuration').value = '';
            }
        }

        function calculateLoan() {
            const amount = parseFloat(document.getElementById('loanAmount').value);
            const rate = parseFloat(document.getElementById('loanInterestRate').value);
            const duration = parseInt(document.getElementById('loanDuration').value);

            if (isNaN(amount) || isNaN(rate) || isNaN(duration) || amount <= 0 || rate < 0 || duration <= 0) {
                alert('لطفاً مقادیر صحیح وارد کنید.');
                return;
            }

            const monthlyRate = (rate / 100) / 12;
            let monthlyInstallment, totalInterest, totalPayment;

            if (monthlyRate === 0) { // Simple interest for 0% rate
                monthlyInstallment = amount / duration;
                totalInterest = 0;
                totalPayment = amount;
            } else {
                monthlyInstallment = amount * monthlyRate * Math.pow(1 + monthlyRate, duration) / (Math.pow(1 + monthlyRate, duration) - 1);
                totalPayment = monthlyInstallment * duration;
                totalInterest = totalPayment - amount;
            }

            document.getElementById('monthlyInstallment').innerText = monthlyInstallment.toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('totalLoanInterest').innerText = totalInterest.toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('totalPayment').innerText = totalPayment.toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('loanResultDiv').style.display = 'block';
        }

        function updateDepositDurationLabel() {
            const days = document.getElementById('depositDurationDays').value;
            document.getElementById('depositDurationLabel').innerText = `${days} روز`;
        }

        function calculateDeposit() {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            const annualRate = parseFloat(document.getElementById('depositInterestRate').value);
            const durationDays = parseInt(document.getElementById('depositDurationDays').value);
            const dailyInterest = document.getElementById('dailyInterestToggle').checked;

            if (isNaN(amount) || isNaN(annualRate) || isNaN(durationDays) || amount <= 0 || annualRate < 0 || durationDays <= 0) {
                alert('لطفاً مقادیر صحیح وارد کنید.');
                return;
            }

            let interestEarned;
            if (dailyInterest) {
                // Daily calculation: (Amount * Annual Rate / 100 / 365) * Days
                interestEarned = (amount * (annualRate / 100) / 365) * durationDays;
            } else {
                // Simple annual calculation (approximated for less than a year)
                // For simplicity, we can still use a daily rate for accuracy over periods
                interestEarned = (amount * (annualRate / 100) / 365) * durationDays;
            }

            const totalAmount = amount + interestEarned;

            document.getElementById('depositInterestEarned').innerText = interestEarned.toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('totalDepositAmount').innerText = totalAmount.toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('depositResultDiv').style.display = 'block';
        }

        // --- Currency Converter Logic (Concise) ---
        const currencies = [
            { name: 'دلار آمریکا', code: 'USD', rateToToman: 50000 },
            { name: 'یورو', code: 'EUR', rateToToman: 55000 },
            { name: 'پوند بریتانیا', code: 'GBP', rateToToman: 63000 },
            { name: 'درهم امارات', code: 'AED', rateToToman: 13600 },
            { name: 'یوان چین', code: 'CNY', rateToToman: 7000 },
            { name: 'لیر ترکیه', code: 'TRY', rateToToman: 1600 },
            { name: 'ریال ایران', code: 'IRR', rateToToman: 1 } // Base for Toman conversions
        ];

        function populateCurrencySelects() {
            const fromCurrencySelect = document.getElementById('fromCurrency');
            const toCurrencySelect = document.getElementById('toCurrency');

            fromCurrencySelect.innerHTML = '';
            toCurrencySelect.innerHTML = '';

            currencies.forEach(currency => {
                const optionFrom = document.createElement('option');
                optionFrom.value = currency.code;
                optionFrom.innerText = `${currency.name} (${currency.code})`;
                fromCurrencySelect.appendChild(optionFrom);

                const optionTo = document.createElement('option');
                optionTo.value = currency.code;
                optionTo.innerText = `${currency.name} (${currency.code})`;
                toCurrencySelect.appendChild(optionTo);
            });

            // Set default selections
            fromCurrencySelect.value = 'USD';
            toCurrencySelect.value = 'IRR';
        }

        function convertCurrency() {
            const amount = parseFloat(document.getElementById('amountToConvert').value);
            const fromCurrencyCode = document.getElementById('fromCurrency').value;
            const toCurrencyCode = document.getElementById('toCurrency').value;

            if (isNaN(amount) || amount <= 0) {
                alert('لطفاً مبلغ معتبری وارد کنید.');
                return;
            }

            const fromCurrency = currencies.find(c => c.code === fromCurrencyCode);
            const toCurrency = currencies.find(c => c.code === toCurrencyCode);

            if (!fromCurrency || !toCurrency) {
                alert('خطا در یافتن اطلاعات ارز. لطفاً دوباره تلاش کنید.');
                return;
            }

            // Convert amount to Toman first, then to target currency
            const amountInToman = amount * fromCurrency.rateToToman;
            const convertedAmount = amountInToman / toCurrency.rateToToman;

            document.getElementById('convertedAmount').innerText = convertedAmount.toLocaleString('fa-IR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ` ${toCurrency.code}`;
            document.getElementById('currencyResultDiv').style.display = 'block';
        }


        // --- Hypothetical Services Calculator Logic ---
        function populateOccupations(selectId) {
            const occupations = [
                "انتخاب کنید", "کارمند", "معلم", "دانشجو", "آزادکار/فریلنسر", "پزشک/پرستار", "مهندس", "راننده", "فروشنده", "کارگر", "خانه‌دار", "بازنشسته", "کشاورز", "معمار", "برنامه‌نویس", "وکیل", "هنرمند", "مدیر", "سرباز/نظامی", "صنعتگر", "بیکار"
            ];
            const selectElement = document.getElementById(selectId);
            selectElement.innerHTML = ''; // Clear existing options
            occupations.forEach(occ => {
                const option = document.createElement('option');
                option.value = occ === "انتخاب کنید" ? "" : occ;
                option.innerText = occ;
                selectElement.appendChild(option);
            });
        }

        document.getElementById('maritalStatus').addEventListener('change', function() {
            document.getElementById('childrenCountGroup').style.display = this.value === 'متاهل' ? 'block' : 'none';
        });

        // Activity Selection Modal Functions
        function showActivitySelectionModal() {
            const modal = document.getElementById('activitySelectionModal');
            const activityOptionsDiv = document.getElementById('activityOptions');
            activityOptionsDiv.innerHTML = ''; // Clear previous content

            for (const category in allActivities) {
                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = `<h4 style="margin-top: 15px; margin-bottom: 10px; color: #FFD700; text-align: right;">${category}</h4>`;

                allActivities[category].forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item-option';
                    activityItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; background-color: #2a2a2a; padding: 8px 12px; border-radius: 6px; border: 1px solid #444;';

                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.style.cssText = 'display: flex; align-items: center;';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `activity-${activity.id}`;
                    checkbox.value = activity.id;
                    checkbox.checked = selectedCustomActivities.some(a => a.id === activity.id); // Check if previously selected
                    checkbox.style.cssText = 'margin-left: 10px; width: 18px; height: 18px; accent-color: #FFA500;';

                    const label = document.createElement('label');
                    label.htmlFor = `activity-${activity.id}`;
                    label.innerText = activity.name;
                    label.style.cssText = 'color: #e0e0e0; font-size: 0.95em; cursor: pointer;';

                    checkboxContainer.appendChild(checkbox);
                    checkboxContainer.appendChild(label);

                    const inputContainer = document.createElement('div');
                    inputContainer.style.cssText = 'display: flex; align-items: center;';

                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.placeholder = activity.unit;
                    quantityInput.min = activity.type === 'free' ? 0 : 0; // Allow 0 for free/monthly/book items if unchecked
                    quantityInput.step = 1;
                    quantityInput.style.cssText = 'width: 60px; padding: 6px; border-radius: 5px; border: 1px solid #666; background-color: #3a3a3a; color: #f0f0f0; text-align: center; margin-left: 8px;';

                    const existingSelection = selectedCustomActivities.find(a => a.id === activity.id);
                    if (existingSelection) {
                        quantityInput.value = existingSelection.count;
                    } else {
                        quantityInput.value = ''; // Default empty
                    }

                    if (!checkbox.checked) { // If not checked initially, disable
                        quantityInput.disabled = true;
                        quantityInput.style.backgroundColor = '#4a4a4a';
                    }

                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            quantityInput.disabled = false;
                            quantityInput.style.backgroundColor = '#3a3a3a';
                            if (activity.type === 'free' && !quantityInput.value) quantityInput.value = 1; // Default to 1 for free if checked
                            if (quantityInput.value === '' && activity.type !== 'free') quantityInput.value = 1; // Default to 1 for non-free if checked and empty
                        } else {
                            quantityInput.disabled = true;
                            quantityInput.value = '';
                            quantityInput.style.backgroundColor = '#4a4a4a';
                        }
                    });

                    inputContainer.appendChild(quantityInput);

                    // Add plus/minus buttons for specific items
                    const itemsWithPlusMinus = ['coffee', 'cinema', 'fastFood', 'cigarette', 'arak', 'whiskey'];
                    if (itemsWithPlusMinus.includes(activity.id)) {
                        const plusMinusDiv = document.createElement('div');
                        plusMinusDiv.className = 'plus-minus-buttons';

                        const minusButton = document.createElement('button');
                        minusButton.innerHTML = '<i class="fas fa-minus"></i>';
                        minusButton.addEventListener('click', () => {
                            let val = parseInt(quantityInput.value) || 0;
                            if (val > 0) quantityInput.value = val - 1;
                            if (checkbox.checked && quantityInput.value == 0 && activity.type !== 'free' && activity.unit !== 'ماه' && activity.unit !== 'کتاب') {
                                checkbox.checked = false; // Uncheck if quantity becomes 0
                                quantityInput.disabled = true;
                                quantityInput.style.backgroundColor = '#4a4a4a';
                            }
                        });

                        const plusButton = document.createElement('button');
                        plusButton.innerHTML = '<i class="fas fa-plus"></i>';
                        plusButton.addEventListener('click', () => {
                            let val = parseInt(quantityInput.value) || 0;
                            quantityInput.value = val + 1;
                            if (!checkbox.checked) {
                                checkbox.checked = true; // Check if quantity increases from 0
                                quantityInput.disabled = false;
                                quantityInput.style.backgroundColor = '#3a3a3a';
                            }
                        });
                        plusMinusDiv.appendChild(minusButton);
                        plusMinusDiv.appendChild(plusButton);
                        inputContainer.appendChild(plusMinusDiv);
                    }


                    activityItem.appendChild(checkboxContainer);
                    activityItem.appendChild(inputContainer);
                    categoryDiv.appendChild(activityItem);
                });
                activityOptionsDiv.appendChild(categoryDiv);
            }
            modal.style.display = 'block';
        }

        function closeActivitySelectionModal() {
            document.getElementById('activitySelectionModal').style.display = 'none';
        }

        function saveSelectedActivities() {
            const tempSelected = [];
            let allValid = true;
            document.getElementById('activityOptions').querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    const activityId = checkbox.value;
                    let activityInfo = null;
                    for (const category in allActivities) {
                        activityInfo = allActivities[category].find(a => a.id === activityId);
                        if (activityInfo) break;
                    }

                    if (activityInfo) {
                        const quantityInput = checkbox.closest('.activity-item-option').querySelector('input[type="number"]');
                        let count = parseFloat(quantityInput.value);

                        // Allow 0 for 'free' type or 'ماه' (monthly) / 'کتاب' (book) units
                        if (isNaN(count) || count < 0 || (count === 0 && activityInfo.type !== 'free' && activityInfo.unit !== 'ماه' && activityInfo.unit !== 'کتاب')) {
                            alert(`لطفاً تعداد دفعات معتبری (بزرگتر از صفر یا صفر برای موارد خاص) برای "${activityInfo.name}" وارد کنید.`);
                            allValid = false;
                            return;
                        }
                        tempSelected.push({
                            id: activityInfo.id,
                            name: activityInfo.name,
                            count: count,
                            minCost: activityInfo.minCost,
                            maxCost: activityInfo.maxCost,
                            type: activityInfo.type,
                            unit: activityInfo.unit
                        });
                    }
                }
            });

            if (!allValid) return; // If any validation failed, stop here

            selectedCustomActivities = tempSelected;
            closeActivitySelectionModal();
            alert('تفریحات دلخواه ذخیره شدند. اکنون می‌توانید بودجه لذت را محاسبه کنید.');
        }


        function calculateHypotheticalServices() {
            const dollarRate = parseFloat(document.getElementById('dollarExchangeRateHypothetical').value);
            const monthlyIncome = parseFloat(document.getElementById('hypotheticalBudget').value.replace(/,/g, ''));
            const userAge = parseInt(document.getElementById('userAge').value);
            const userOccupation = document.getElementById('userOccupation').value;
            const maritalStatus = document.getElementById('maritalStatus').value;
            const childrenCount = maritalStatus === 'متاهل' ? parseInt(document.getElementById('childrenCount').value) : 0;
            const livingArea = document.getElementById('livingArea').value;
            const houseOwnership = document.getElementById('houseOwnership').value;
            const carOwnership = document.getElementById('carOwnership').value;

            if (isNaN(dollarRate) || dollarRate <= 0 || isNaN(monthlyIncome) || monthlyIncome <= 0 || isNaN(userAge) || userAge <= 0 ||
                !userOccupation || !maritalStatus || !livingArea || !houseOwnership || !carOwnership || (maritalStatus === 'متاهل' && isNaN(childrenCount))) {
                alert('لطفاً تمام فیلدهای اطلاعات کاربر را به درستی پر کنید.');
                return;
            }

            if (selectedCustomActivities.length === 0) {
                alert('لطفاً حداقل یک تفریح یا خدمات دلخواه را انتخاب کنید.');
                return;
            }

            let totalSelectedActivityCostUSD = 0;
            const activityTableBody = document.getElementById('activityTableBody');
            activityTableBody.innerHTML = ''; // Clear previous table content

            selectedCustomActivities.forEach(activity => {
                const avgCostUSD = (activity.minCost + activity.maxCost) / 2;
                const activityTotalCostUSD = avgCostUSD * activity.count;
                totalSelectedActivityCostUSD += activityTotalCostUSD;

                const row = activityTableBody.insertRow();
                const cell1 = row.insertCell(0);
                const cell2 = row.insertCell(1);
                const cell3 = row.insertCell(2);

                cell1.innerText = activity.name;
                cell2.innerText = `${activity.count} ${activity.unit}`;
                cell3.innerText = (activityTotalCostUSD * dollarRate).toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' تومان';
            });

            // Add estimated fixed costs
            let estimatedFixedCostsUSD = 0;
            if (livingArea === 'شهری' && houseOwnership === 'مستأجر') {
                estimatedFixedCostsUSD += (iranianServiceCostsUSD['اجاره خانه شهری (ماهیانه)'].min + iranianServiceCostsUSD['اجاره خانه شهری (ماهیانه)'].max) / 2;
            } else if (livingArea === 'روستایی' && houseOwnership === 'مستأجر') {
                estimatedFixedCostsUSD += (iranianServiceCostsUSD['اجاره خانه روستایی (ماهیانه)'].min + iranianServiceCostsUSD['اجاره خانه روستایی (ماهیانه)'].max) / 2;
            }

            // Always add basic fixed costs
            estimatedFixedCostsUSD += (iranianServiceCostsUSD['اینترنت ماهانه خانگی'].min + iranianServiceCostsUSD['اینترنت ماهانه خانگی'].max) / 2;
            estimatedFixedCostsUSD += (iranianServiceCostsUSD['قبوض آب و برق و گاز (ماهانه)'].min + iranianServiceCostsUSD['قبوض آب و برق و گاز (ماهانه)'].max) / 2;
            estimatedFixedCostsUSD += (iranianServiceCostsUSD['لوازم بهداشتی/شوینده (ماهانه)'].min + iranianServiceCostsUSD['لوازم بهداشتی/شوینده (ماهانه)'].max) / 2;
            estimatedFixedCostsUSD += (iranianServiceCostsUSD['میوه و سبزیجات (ماهانه)'].min + iranianServiceCostsUSD['میوه و سبزیجات (ماهانه)'].max) / 2;
            estimatedFixedCostsUSD += (iranianServiceCostsUSD['پروتئین (گوشت، مرغ، ماهی) (ماهانه)'].min + iranianServiceCostsUSD['پروتئین (گوشت، مرغ، ماهی) (ماهانه)'].max) / 2;
            estimatedFixedCostsUSD += (iranianServiceCostsUSD['پوشاک (ماهانه، تقریبی)'].min + iranianServiceCostsUSD['پوشاک (ماهانه، تقریبی)'].max) / 2;

            if (carOwnership === 'دارم') {
                estimatedFixedCostsUSD += (iranianServiceCostsUSD['تعمیر و نگهداری خودرو (ماهیانه، تقریبی)'].min + iranianServiceCostsUSD['تعمیر و نگهداری خودرو (ماهیانه، تقریبی)'].max) / 2;
                estimatedFixedCostsUSD += (iranianServiceCostsUSD['بنزین/سوخت خودرو (ماهیانه, تقریبی)'].min + iranianServiceCostsUSD['بنزین/سوخت خودرو (ماهیانه, تقریبی)'].max) / 2;
            }

            const totalFixedCostsToman = estimatedFixedCostsUSD * dollarRate;
            const totalActivityCostToman = totalSelectedActivityCostUSD * dollarRate;
            const grandTotalExpensesToman = totalFixedCostsToman + totalActivityCostToman;
            const remainingMoneyToman = monthlyIncome - grandTotalExpensesToman;

            document.getElementById('displayMonthlyIncome').innerText = monthlyIncome.toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' تومان';
            document.getElementById('totalActivityCost').innerText = grandTotalExpensesToman.toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' تومان';
            document.getElementById('totalActivityCostFooter').innerText = totalActivityCostToman.toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' تومان';


            let budgetAdviceHTML = '';
            let overspendWarningDiv = document.getElementById('expenseCutSuggestions');
            let cutSuggestionsList = document.getElementById('cutSuggestionsList');
            cutSuggestionsList.innerHTML = ''; // Clear previous suggestions

            if (remainingMoneyToman >= 0.2 * monthlyIncome) {
                budgetAdviceHTML = `شما در وضعیت <span class="highlight">مالی بسیار خوبی</span> قرار دارید! می‌توانید با خیال راحت‌تری پس‌انداز کنید یا به سرمایه‌گذاری‌های بزرگ‌تر فکر کنید.`;
                overspendWarningDiv.style.display = 'none';
            } else if (remainingMoneyToman >= 0 && remainingMoneyToman < 0.2 * monthlyIncome) {
                budgetAdviceHTML = `شما در وضعیت <span class="highlight">متعادلی</span> قرار دارید و می‌توانید هم از زندگی لذت ببرید و هم پس‌انداز کنید. تعادل بین خرج کردن و پس‌انداز کلید موفقیت شماست.`;
                overspendWarningDiv.style.display = 'none';
            } else {
                budgetAdviceHTML = `شما این ماه <span class="highlight negative-point">${(-remainingMoneyToman).toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} تومان</span> کسری بودجه دارید. برای تعادل دخل و خرج، نیاز به بازبینی هزینه‌هاست.`;
                overspendWarningDiv.style.display = 'block';

                // Suggest cuts
                const categoriesToCut = ['luxury', 'leisure', 'culture', 'food', 'travel', 'personal'];
                const potentialCuts = [];

                // Sort selected activities by cost (descending) to suggest cutting more expensive ones first
                const sortedActivities = [...selectedCustomActivities].sort((a, b) => {
                    const costA = ((a.minCost + a.maxCost) / 2) * a.count;
                    const costB = ((b.minCost + b.maxCost) / 2) * b.count;
                    return costB - costA;
                });

                let deficitToCover = -remainingMoneyToman;

                for (const activity of sortedActivities) {
                    if (categoriesToCut.includes(activity.type) && activity.count > 0) {
                        const avgCostUSD = (activity.minCost + activity.maxCost) / 2;
                        const activityCostToman = avgCostUSD * activity.count * dollarRate;

                        if (deficitToCover > 0 && activityCostToman > 0) {
                             if (activity.unit === 'بار' || activity.unit === 'پاکت' || activity.unit === 'بطری') {
                                // Suggest reducing count for per-item expenses
                                let reductionCount = 0;
                                let remainingCount = activity.count;
                                while (deficitToCover > 0 && remainingCount > 0) {
                                    const costPerUnit = avgCostUSD * dollarRate;
                                    if (deficitToCover >= costPerUnit) {
                                        deficitToCover -= costPerUnit;
                                        reductionCount++;
                                        remainingCount--;
                                    } else {
                                        // If remaining deficit is less than one unit, suggest reducing that unit
                                        potentialCuts.push(`کاهش ${activity.name} به میزان ${activity.count - remainingCount} ${activity.unit} (صرفه جویی حدود ${activityCostToman.toLocaleString('fa-IR')} تومان)`);
                                        deficitToCover = 0;
                                        break;
                                    }
                                }
                                if (reductionCount > 0) {
                                    potentialCuts.push(`کاهش ${activity.name} به میزان ${reductionCount} ${activity.unit} (صرفه جویی حدود ${(avgCostUSD * reductionCount * dollarRate).toLocaleString('fa-IR')} تومان)`);
                                }
                            } else if (activity.unit === 'ماه' || activity.unit === 'کتاب' || activity.unit === 'ساعت') {
                                // Suggest eliminating for monthly/book/hourly or reducing
                                if (activityCostToman >= deficitToCover) {
                                    potentialCuts.push(`حذف کامل ${activity.name} (صرفه جویی حدود ${activityCostToman.toLocaleString('fa-IR')} تومان)`);
                                    deficitToCover = 0;
                                } else {
                                    potentialCuts.push(`بررسی امکان کاهش ${activity.name} (هزینه حدود ${activityCostToman.toLocaleString('fa-IR')} تومان)`);
                                    deficitToCover -= activityCostToman;
                                }
                            }
                        }
                    }
                }

                if (potentialCuts.length === 0 && deficitToCover > 0) {
                    potentialCuts.push('بررسی دقیق‌تر تمامی هزینه‌ها برای یافتن موارد قابل کاهش.');
                }

                potentialCuts.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.innerText = suggestion;
                    cutSuggestionsList.appendChild(li);
                });
            }

            document.getElementById('budgetSuggestionText').innerHTML = budgetAdviceHTML;
            document.getElementById('remainingOrDeficitAmount').innerText = Math.abs(remainingMoneyToman).toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' تومان';
            if (remainingMoneyToman < 0) {
                document.getElementById('remainingOrDeficitAmount').classList.add('overspend-warning');
            } else {
                document.getElementById('remainingOrDeficitAmount').classList.remove('overspend-warning');
            }


            document.getElementById('hypotheticalServicesResultDiv').style.display = 'block';
        }


        // Initial setup: On page load, no section is active by default.
        document.addEventListener('DOMContentLoaded', () => {
            // Apply saved theme on load
            const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark
            const body = document.body;
            const themeToggleBtn = document.getElementById('themeToggle');
            if (savedTheme === 'light') {
                body.classList.add('light-theme');
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                body.classList.remove('light-theme');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            }

            // Populate occupations for the main input form
            populateOccupations('userOccupation');

            // Set up event listener for marital status in main form
            document.getElementById('maritalStatus').addEventListener('change', function() {
                document.getElementById('childrenCountGroup').style.display = this.value === 'متاهل' ? 'block' : 'none';
            });
            // Initial dispatch for main form marital status to set initial display
            document.getElementById('maritalStatus').dispatchEvent(new Event('change'));

            // Populate currency selects on load
            populateCurrencySelects();

            // Set default active tab for Loan/Deposit calculator
            document.getElementById('loanContent').style.display = 'block';
            document.querySelector('#loanDepositCalculator .tab-button:first-child').classList.add('active');

            // Activate the default calculator (Gold Calculator)
            document.getElementById('goldCalculator').style.display = 'block';
            document.querySelector('.nav-button[data-target="goldCalculator"]').classList.add('active');
            document.documentElement.style.setProperty('--button-color', document.querySelector('.nav-button.active').dataset.color);
        });
    </script>
</body>
</html>
